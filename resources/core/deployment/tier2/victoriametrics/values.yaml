# VictoriaMetrics Kubernetes Stack
# Prometheus-compatible metrics and monitoring
# https://docs.victoriametrics.com/

victoria-metrics-operator:
  admissionWebhooks:
    policy: Ignore

vmagent:
  enabled: true
  spec:
    selectAllByDefault: true
    nodeScrapeSelector: {}
    nodeScrapeNamespaceSelector: {}
    scrapeInterval: "20s"

    externalLabels:
      cluster: nova

    extraArgs:
      promscrape.dropOriginalLabels: "true"
      promscrape.streamParse: "true"

kubelet:
  enabled: true

  vmScrape:
    kind: VMNodeScrape
    spec:
      scheme: "https"
      scrapeTimeout: "5s"
      interval: "30s"

      honorLabels: true
      honorTimestamps: false

      bearerTokenFile: "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tlsConfig:
        caFile: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"

      metricRelabelConfigs:
        - action: labeldrop
          regex: "(uid)"
        - action: labeldrop
          regex: "(id|name)"
        - action: drop
          source_labels: [__name__]
          regex: "(rest_client_request_duration_seconds_bucket|rest_client_request_duration_seconds_sum|rest_client_request_duration_seconds_count)"
        - action: labeldrop
          regex: "feature_node_kubernetes_io_.*"
        - action: labeldrop
          regex: "nvidia_com_.*"
        - action: replace
          source_labels: [image]
          regex: "([^@]+)(?:@.*)?"
          replacement: "$1"
          target_label: image
        - action: replace
          source_labels: [image]
          regex: "^$"
          replacement: "unknown"
          target_label: image

      relabelConfigs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - sourceLabels: [__metrics_path__]
          targetLabel: metrics_path
        - targetLabel: "job"
          replacement: "kubelet"
        - source_labels: [__meta_kubernetes_node_name]
          target_label: kubernetes_node

  vmScrapes:
    cadvisor:
      enabled: false
      spec:
        path: /metrics/cadvisor

    probes:
      enabled: true
      spec:
        path: /metrics/probes

    resources:
      enabled: true
      spec:
        path: /metrics/resource

kubeEtcd:
  enabled: false

kubeControllerManager:
  enabled: false

kubeScheduler:
  enabled: false

defaultDatasources:
  extra:
    - name: VictoriaLogs
      type: victoriametrics-logs-datasource
      url: http://vls-victoria-logs-single-server.victorialogs.svc.cluster.local:9428
      access: proxy
      isDefault: false

grafana:
  enabled: true

  envValueFrom:
    GF_AUTH_GENERIC_OAUTH_CLIENT_ID:
      secretKeyRef:
        name: oidc
        key: client-id
    GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
      secretKeyRef:
        name: oidc
        key: client-secret

  grafana.ini:
    server:
      domain: "grafana.{{.Domain}}"
      root_url: "https://grafana.{{.Domain}}"
    auth:
      disable_login_form: true
      oauth_auto_login: true
    auth.generic_oauth:
      enabled: true
      name: "Keycloak"
      allow_sign_up: true
      scopes: "openid email profile offline_access roles"
      auth_url: "https://{{.AuthDomain}}/realms/nova/protocol/openid-connect/auth"
      token_url: "https://{{.AuthDomain}}/realms/nova/protocol/openid-connect/token"
      api_url: "https://{{.AuthDomain}}/realms/nova/protocol/openid-connect/userinfo"
      role_attribute_path: "contains(roles[*], 'admin') && 'Admin' || contains(roles[*], 'editor') && 'Editor' || 'Viewer'"
      tls_skip_verify_insecure: true

    security:
      disable_initial_admin_creation: false
      allow_embedding: true
      cookie_secure: false

  admin:
    existingSecret: grafana-admin

  plugins:
    - victoriametrics-logs-datasource

  ingress:
    enabled: false

  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: "victoriametrics"

extraObjects:
  - apiVersion: operator.victoriametrics.com/v1beta1
    kind: VMNodeScrape
    metadata:
      name: cadvisor-via-apiserver
      namespace: victoriametrics
      labels:
        app.kubernetes.io/name: cadvisor-via-apiserver
    spec:
      scheme: https
      honorLabels: true
      honorTimestamps: false
      interval: 30s
      scrapeTimeout: 5s
      tlsConfig:
        insecureSkipVerify: true
        caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token

      metricRelabelConfigs:
        - action: labeldrop
          regex: "(uid)"
        - action: labeldrop
          regex: "(id|name)"
        - action: labeldrop
          regex: "feature_node_kubernetes_io_.*"
        - action: labeldrop
          regex: "nvidia_com_.*"
        - action: replace
          source_labels: [image]
          regex: "([^@]+)(?:@.*)?"
          replacement: "$1"
          target_label: image
        - action: replace
          source_labels: [image]
          regex: "^$"
          replacement: "unknown"
          target_label: image

      relabelConfigs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - targetLabel: __address__
          replacement: kubernetes.default.svc:443
        - sourceLabels: [__meta_kubernetes_node_name]
          regex: (.+)
          targetLabel: __metrics_path__
          replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
        - targetLabel: metrics_path
          replacement: /metrics/cadvisor
        - targetLabel: job
          replacement: kubelet
        - source_labels: [__meta_kubernetes_node_name]
          target_label: kubernetes_node

  - apiVersion: operator.victoriametrics.com/v1beta1
    kind: VMPodScrape
    metadata:
      name: nvidia-dcgm-exporter
      namespace: victoriametrics
    spec:
      namespaceSelector:
        matchNames:
          - nvidia-gpu-operator
      selector:
        matchLabels:
          app: nvidia-dcgm-exporter
      podMetricsEndpoints:
        - port: metrics
          path: /metrics
          interval: 30s
          scrapeTimeout: 5s
          honorLabels: true
          honorTimestamps: false
          relabelConfigs:
            - targetLabel: job
              replacement: nvidia-dcgm-exporter
